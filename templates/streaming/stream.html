<!-- stream.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Stream Video</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    {% csrf_token %}
</head>
<body>
    <h1>Webcam Streaming</h1>
    <div id="videoContainer"></div>
    <button id="startButton">Start</button>
    <button id="stopButton">Stop</button>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let videoContainer = document.getElementById('videoContainer');
            let startButton = document.getElementById('startButton');
            let stopButton = document.getElementById('stopButton');
            let videoStreams = [];
            let sockets = [];

            // Get the room name dynamically from the URL
            let roomName = window.location.pathname.split('/').slice(-2, -1)[0];
            console.log(roomName)

            function startCapture() {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function(stream) {
                        // Create a new video element for the stream
                        let videoElement = document.createElement('video');
                        videoElement.autoplay = true;
                        videoContainer.appendChild(videoElement);

                        // Add the stream to the video element
                        videoElement.srcObject = stream;
                        videoStreams.push(stream);

                        // Send request to start capturing video
                        sendRequest('/capture_video/start/', 'POST', null, function() {
                            console.log('Video capture started.');
                        }, function(xhr, status, error) {
                            console.error('Error starting video capture:', error);
                        });

                        // Connect to WebSocket server
                        let socket = new WebSocket('ws://' + window.location.host + '/ws/stream/' + roomName + '/');
                        sockets.push(socket);
                        socket.onopen = function() {
                            console.log('WebSocket connection established.');
                        };

                        // Initialize the current playback position from shared resource
                        let playbackPosition = 0; // Example: using local storage
                        if (localStorage.getItem('playbackPosition')) {
                            playbackPosition = parseInt(localStorage.getItem('playbackPosition'));
                        }

                        // Handle received video frames
                        socket.onmessage = function(event) {
                            // Parse the received video frame data
                            let frameData = JSON.parse(event.data);
                            let timestamp = frameData.timestamp;
                            let frame = frameData.frame;
                            let frameCounter = frameData.frame_counter;

                            // Compare the frame timestamp or sequence number with the current playback position
                            if (frameCounter >= playbackPosition) {
                                // Update the playback position to the current frame counter
                                playbackPosition = frameCounter;

                                // Store the updated playback position in the shared resource (local storage)
                                localStorage.setItem('playbackPosition', playbackPosition.toString());

                                // Process and display the received video frames
                                // Find the corresponding video element for the stream and update its source
                                let index = videoStreams.indexOf(stream);
                                if (index !== -1) {
                                    let videoElement = videoContainer.getElementsByTagName('video')[index];
                                    videoElement.srcObject = URL.createObjectURL(frame);
                                }
                            }
                        };

                        // Send video frames to server
                        let mediaRecorder = new MediaRecorder(stream);
                        mediaRecorder.ondataavailable = function(e) {
                            if (socket.readyState === WebSocket.OPEN) {
                                // Create a data object with the frame and frame counter
                                let frameData = {
                                    timestamp: Date.now().toString(),
                                    frame: e.data,
                                    frame_counter: playbackPosition
                                };

                                // Send the frame data as JSON string
                                socket.send(JSON.stringify(frameData));
                            }
                        };
                        mediaRecorder.start(1000);  // Adjust the interval as needed
                    })
                    .catch(function(error) {
                        console.error('Error accessing webcam:', error);
                    });
            }

            function stopCapture() {
                // Stop capturing video for all streams
                videoStreams.forEach(function(stream) {
                    stream.getTracks().forEach(function(track) {
                        track.stop();
                    });
                });

                // Send request to stop capturing video
                sendRequest('/capture_video/stop/', 'POST', null, function() {
                    console.log('Video capture stopped.');
                }, function(xhr, status, error) {
                    console.error('Error stopping video capture:', error);
                });

                // Disconnect from WebSocket servers
                sockets.forEach(function(socket) {
                    if (socket.readyState === WebSocket.OPEN) {
                        socket.close();
                    }
                });

                // Clear the video container and streams array
                videoContainer.innerHTML = '';
                videoStreams = [];
                sockets = [];
            }

            function sendRequest(url, method, data, successCallback, errorCallback) {
                $.ajax({
                    url: url,
                    method: method,
                    data: data,
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                    success: successCallback,
                    error: errorCallback
                });
            }

            startButton.addEventListener('click', function() {
                startCapture();
            });

            stopButton.addEventListener('click', function() {
                stopCapture();
            });
        });
    </script>
</body>
</html>
